# ì¬í™œìš© í’ˆëª© ë¶„ë¥˜ë¥¼ ìœ„í•œ Sementic Segmentation in Bostcamp

## ğŸ’» í•˜ë‚˜ë‘˜ì…‹Net()

### ğŸ˜ Members

---

|                                     [ê³µì€ì°¬](https://github.com/Chanchan2)                                      |                                       [ê³½ë¯¼êµ¬](https://github.com/deokgu)                                       |                                      [ê¹€ì¤€ì„­](https://github.com/Aweseop)                                       |                                     [ê¹€ì§„ìš©](https://github.com/Kim-jy0819)                                     |                                       [ì‹¬ìš©ì² ](https://github.com/ShimYC)                                       |                               [ì˜¤ì¬ì„](https://github.com/dmole20)                                |                                     [ìµœí˜„ì§„](https://github.com/hyeonjini)                                      |
| :-------------------------------------------------------------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: | :-----------------------------------------------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------: |
| ![image](https://user-images.githubusercontent.com/13193985/140293018-d3a12aa8-485b-4c97-b6ab-a9dc78a81c99.jpg) | ![image](https://user-images.githubusercontent.com/35412566/138591171-7b883dcd-7b83-492e-a251-9eb2960d6e62.png) | ![image](https://user-images.githubusercontent.com/35412566/138591221-5c2b12cc-c2db-4679-892f-a0aa034cdf77.png) | ![image](https://user-images.githubusercontent.com/63527907/140073918-839313ff-76f0-4bd1-a1da-2b68880c8f43.png) | ![image](https://github.com/ShimYC/ShimYC.github.io/blob/main/images/KakaoTalk_20211104_233517667.jpg?raw=true) |                ![image](https://avatars.githubusercontent.com/u/52789601?s=40&v=4)                | ![image](https://github.com/hyeonjini.png) |
| [**Notion**](https://flint-failing-3c9.notion.site/006b28bf92104405834e3fb3ef1fdc99)                                                                                                             |                                [**TIL**](https://github.com/deokgu/deokgu/wiki)                                 |   [**Git**](https://github.com/Aweseop)                                                                                                              | [**Blog**](https://near-prawn-9c5.notion.site/Naver-Boost-Camp-AI-Tech-2-2e4303f8bd2e4f36be8916d04cbd123a)                                                                                                                | [**Notion**](https://bubbly-cost-eda.notion.site/AI-boostcamp-memo-2f012708dd2645bb9962679ad51c6490)                                                                                                                | [**TIL**](https://fair-dahlia-cc2.notion.site/BoostCamp-AI-Tech-48bd706756aa49e0b74ca2d2ffda962a) |[**Devlog**](https://velog.io/@choihj94)                                                                                                                 |

---

## ğŸ” Competition Overview

<br>

![image](https://user-images.githubusercontent.com/35412566/139359859-ea1469d8-8bd9-41f3-b09e-4b190ab795db.png)

##### ì˜ ë¶„ë¦¬ ë°°ì¶œ ëœ ì“°ë ˆê¸°ëŠ” ìì›ìœ¼ë¡œì„œ ê°€ì¹˜ë¥¼ ì¸ì •ë°›ì•„ ì¬í™œìš©ë˜ì§€ë§Œ, ì˜ëª» ë¶„ë¦¬ë°°ì¶œ ë˜ë©´ ê·¸ëŒ€ë¡œ íê¸°ë¬¼ë¡œ ë¶„ë¥˜ë˜ì–´ ë§¤ë¦½ ë˜ëŠ” ì†Œê°ë˜ê¸° ë©ë‹ˆë‹¤.

##### ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì‚¬ì§„ì—ì„œ ì“°ë ˆê¸°ë¥¼ Segmentationí•˜ëŠ” ëª¨ë¸ì„ ë§Œë“¤ì–´ ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•´ë³´ê³ ì í•©ë‹ˆë‹¤. ë¬¸ì œ í•´ê²½ì„ ìœ„í•œ ë°ì´í„°ì…‹ìœ¼ë¡œëŠ” ë°°ê²½, ì¼ë°˜ ì“°ë ˆê¸°, í”Œë¼ìŠ¤í‹±, ì¢…ì´, ìœ ë¦¬ ë“± 11ì¢…ë¥˜ì˜ ì“°ë ˆê¸°ê°€ ì°íŒ ì‚¬ì§„ ë°ì´í„°ì…‹ì´ ì œê³µë©ë‹ˆë‹¤.

##### ì—¬ëŸ¬ë¶„ì— ì˜í•´ ë§Œë“¤ì–´ì§„ ìš°ìˆ˜í•œ ì„±ëŠ¥ì˜ ëª¨ë¸ì€ ì“°ë ˆê¸°ì¥ì— ì„¤ì¹˜ë˜ì–´ ì •í™•í•œ ë¶„ë¦¬ìˆ˜ê±°ë¥¼ ë•ê±°ë‚˜, ì–´ë¦°ì•„ì´ë“¤ì˜ ë¶„ë¦¬ìˆ˜ê±° êµìœ¡ ë“±ì— ì‚¬ìš©ë  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

---

## ğŸ‰ ìˆ˜í–‰ê²°ê³¼ best score?

### âœ¨ ë¦¬ë”ë³´ë“œ(ëŒ€íšŒ ì§„í–‰): **11ìœ„** mIoU : 0.757

### ğŸŠ ë¦¬ë”ë³´ë“œ(ìµœì¢…): **14ìœ„** mIoU : 0.706

<br>

---

## ğŸ® Requirements

- Linux version 4.4.0-59-generic
- Python >= 3.8.5
- PyTorch >= 1.7.1
- conda >= 4.9.2
- tensorboard >= 2.4.1

### âŒ¨ Hardware

- CPU: Intel(R) Xeon(R) Gold 5220 CPU @ 2.20GHz
- GPU: Tesla V100-SXM2-32GB
  <br>

## ğŸ” Reference

- [MMsegmentation](https://github.com/open-mmlab/mmsegmentation)
- [RAdam](https://github.com/LiyuanLucasLiu/RAdam/blob/master/radam/radam.py)
- [Copy-Paste](https://arxiv.org/pdf/2012.07177v1.pdf)
  <br>
  
## ğŸ“ ì—­í• 
| íŒ€êµ¬ì„±  | ì—­í•  |
| :---:   | :---:|
| ê³µì€ì°¬_T2009| Custom loss, Optimizer ì ìš©|
| ê³½ë¯¼êµ¬_T2255| Optimizer, Loss, Scheduler Test ì§„í–‰ |
| ê¹€ì¤€ì„­_T2056| Segmentation Multi-label Stratified K-fold êµ¬ì„±|
| ê¹€ì§„ìš©_T2063| Copy paste ë°ì´í„° ì…‹ ì œì‘|
| ì‹¬ìš©ì² _T2122| Model íƒìƒ‰, Resize ë° weighted loss ì‹¤íš¨ì„± ê²€ì¦|
| ì˜¤ì¬ì„_T2133| Stratified K-fold ë°ì´í„°ì…‹ ì½”ë“œ í‹€ ì‘ì„±|
| ìµœí˜„ì§„_T2234| Baseline Code ì‘ì„±, Pseudo Labeling, Oversampling|


# ğŸ”¨ ìˆ˜í–‰ ê³¼ì •

---

## ğŸ”‘ Validation Dataset êµ¬ì„±
- Segmentation taskì—ì„œ ë°ì´í„°ë¥¼ reasonableí•˜ê²Œ train/val datasetì„ ë‚˜ëˆ„ê¸° ìœ„í•¨
- ì•„ë˜ì™€ ê°™ì´ ê° ì´ë¯¸ì§€ë§ˆë‹¤ 3ê°€ì§€ labelì„ ì •ì˜ í›„ Multi-label Stratified K-Foldë¡œ ë°ì´í„°ë¥¼ ë‚˜ëˆ”
```
 ìˆ˜ê°€ ì ì€ Classë¥¼ ìµœëŒ€í•œ í¬í•¨í•˜ê¸° ìœ„í•´ ì´ë¯¸ì§€ë§ˆë‹¤ ê°€ì¥ ì ì€ ìˆ˜ì— í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì´ë¯¸ì§€ì˜ í´ë˜ìŠ¤ë¡œ ì •ì˜
 ì´ë¯¸ì§€ë‹¹ Classì˜ ìˆ˜
 ì´ë¯¸ì§€ë‹¹ Annotationì˜ ìˆ˜
````
 ![image](https://user-images.githubusercontent.com/35412566/140275405-f42a0fd4-37ae-41be-986f-39ee5a6847c9.png)


<br>

---

## ğŸ”‘ Oversampling
![image](https://user-images.githubusercontent.com/35412566/140275754-58e33ecd-8e5b-4581-8655-6f153ed11412.png)
<br>

![image](https://user-images.githubusercontent.com/35412566/140275802-3f83cd8e-9854-422d-86b3-c58c2051af5a.png)

<br>

---

## ğŸ”‘ Pseudo Labeling
- ê°€ì¥ ì„±ëŠ¥ì´ ì¢‹ì€ ëª¨ë¸ì˜ inference ê²°ê³¼ë¡œ í•™ìŠµ ë°ì´í„°ë¥¼ ë§Œë“¤ê³  ì¬í•™ìŠµ
- Segmentation task íŠ¹ì„±ìœ¼ë¡œ ì ìˆ˜ í¬ê²Œ í–¥ìƒ(0.727 -> 0.75)

<br>

---
## ğŸ”‘ DenseCRF
- Dense CRF ê¸°ë²•ì„ ì ìš©í•´ boundary ì¢€ ë” ëšœë ·í•˜ê²Œ ë°˜ì˜, ë‹¨ì¼ ê°ì²´ì—ì„œ ì„±ëŠ¥ í–¥ìƒ ê¸°ëŒ€
![image](https://user-images.githubusercontent.com/35412566/140275995-7967b185-5dd8-4e74-b36c-0558408a436c.png)

<br>

---

## ğŸ“‚ Archive contents

```
baseline/
â”œâ”€â”€ train.py # main
â”œâ”€â”€ trainer.py
â”œâ”€â”€ dataset.py
â”œâ”€â”€ test.py
â”œâ”€â”€ utils.py
â””â”€â”€ models/ # train model package
â””â”€â”€ loss/ # loss metric package
â””â”€â”€ scheduler/ # scheduler package
â””â”€â”€ model
  â””â”€â”€ exp1/ # model file will save here
```

```
util/
â”œâ”€â”€ oversampling.py
â””â”€â”€ pseudo_labeling.py
```

```
copy_paste/
â”œâ”€ check_copy_paste.ipynb
â”œâ”€ copy_paste.py
â”œâ”€ mask_convert_json.py
â”œâ”€ get_coco_mask.py
â”œâ”€ README.md
â””â”€ requirements.txt
```

<br>

## ğŸ’Copy Paste

<br>

### Augmentation Method:
1. Random Horizontal Flip
2. Large Scale Jittering
3. Copy-Paste
4. Large patch to Small patch
5. Small patch to Large patch
6. Random Flip

### Copy_paste Quick Start 

### 1. ì‰˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³ ì í•œë‹¤ë©´ í•´ë‹¹ ë””ë ‰í† ë¦¬ì— ë“¤ì–´ê°€ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•œë‹¤.
```
./aug.sh
```
<br>

### 2. ëª…ë ¹ì–´ë¥¼ ë”°ë¡œ ì…ë ¥í•˜ê³ ì í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•œë‹¤.
#### 1. ëª¨ë“ˆ ì„¤ì¹˜í•˜ê¸°
```
pip install -r requirements.txt
```

<br>

#### 2. ì›ë³¸ ì´ë¯¸ì§€ì™€ json íŒŒì¼ì„ í†µí•´ segmentation mask ìƒì„±
```
python get_coco_mask.py  
--input_dir ../../input/data/ 
--split train_all
```

<br>

#### 3. ì›ë³¸ ì´ë¯¸ì§€, ì›ë³¸ mask, ëœë¤ ì´ë¯¸ì§€, ëœë¤ maskë¡œë¶€í„° copy_paste
```
python copy_paste.py --input_dir ../../input/data/ --output_dir ../../input/data/ 
--patch ["Paper pack", "Battery", "Plastic", 'Clothing',"Glass" ]
--remove_patch ["Paper", "Plastic bag"]
--json_path train.json
--lsj True
--lsj_max 2
--lsj_min 0.2
--aug_num 1500
--extract_patch True
```

![image](https://user-images.githubusercontent.com/63527907/139034387-1ec9d9c8-3dcd-4859-9f8a-5ead0fe54f40.png)

<br>

#### 4. maskë¡œë¶€í„° jsoníŒŒì¼ë¡œ ë³€í™˜
```
python mask_coco_mask.py
--main_json train.json
--mode add
```

#### 5. ê²°ê³¼

![image](https://user-images.githubusercontent.com/63527907/139034173-370fd30e-42dc-40c3-afe1-00ed559fbb2a.png)
---

## ğŸ›’ Train Test Quickstart
```
python train.py \
--model UPlusPlus_Efficient_b5 \
--epochs 200 \
--loss FocalLoss \
--val_json kfold_0_val.json \
--train_json kfold_0_train.json \
--train_augmentation CustomTrainAugmentation \
--batch_size 5
```
```
python test.py python test.py --model_dir model/exp --model_name epoch10.pth --augmentation TestAugmentation
```
- reference here `exmple/`

- íŒŒì¼ êµ¬ì¡°ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/63527907/142895213-49b5bcc6-7ba3-4583-a28e-b251676c45bc.png)

```
python convert_coco_data.py
```
